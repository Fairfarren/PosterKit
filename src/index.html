<!doctype html>
<html dir="ltr" lang="en">
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=5.0"
    />
    <title>Stencil Component Starter</title>
    <script type="module" src="./build/designkit.esm.js"></script>
    <script nomodule src="./build/designkit.js"></script>
    <style>
      * {
        margin: 0;
        padding: 0;
      }

      .box {
        width: 100vw;
        height: 500px;
        border: 2px solid black;
        box-sizing: border-box;
      }

      .dataDiv {
        padding: 20px;
      }

      .canvasPoster {
        width: 500px;
        height: 500px;
        border: 2px solid black;
        box-sizing: border-box;
        margin-top: 20px;
        object-fit: contain;
      }
    </style>
  </head>

  <body>
    <div class="box">
      <kit-box id="kitBox" width="1080" height="1920"></kit-box>
    </div>

    <div>
      <div>
        <button onclick="init()">init two data in list</button>
      </div>
      <div>
        <button onclick="add()">addImage</button>
      </div>
      <div>
        <button onclick="addText()">addText</button>
      </div>
      <div>
        <button onclick="getList()">getList</button>
      </div>
      <div>
        <button onclick="createPoster()">create poster</button>
      </div>
    </div>

    <div class="dataDiv">
      å½“å‰é€‰ä¸­æ•°æ®:
      <span id="currentDataJson" contenteditable="true"></span>
      <form id="form"></form>
      <div>
        <button onclick="updateCurrentData()">ç¡®å®šæ›´æ”¹å‚æ•°</button>
      </div>
    </div>

    <div>
      <img class="canvasPoster" />
    </div>
  </body>
  <script>
    const image = new Image()
    image.src =
      'https://material-center.meitudata.com/material/image/62fa22ac354485399.png'
    image.crossOrigin = 'anonymous'
    const defaultImage = {
      id: new Date().getTime(),
      width: 300,
      height: 300,
      x: 0,
      y: 0,
      image,
      type: 'image',
    }

    const defaultText = {
      id: new Date().getTime() + 1,
      width: 300,
      height: 200,
      x: 0,
      y: 0,
      text: 'ä½ å¥½ä¸–ç•Œä½ å¥½ä¸–ç•Œ1234567890ğŸ¤”abcdefghijklmnopqrstuvwxyz',
      type: 'text',
      fontSize: 32,
      fontFamily: 'cursive',
      color: '#db3f9178',
      fontWeight: 'bold',
      fontStyle: 'italic',
      decoration: 'line-through',
    }

    let currentData = {}
    // æ·»åŠ äº‹ä»¶ç›‘å¬å™¨
    document.addEventListener('DOMContentLoaded', function () {
      const kitBox = document.querySelector('#kitBox')
      kitBox.addEventListener('currentDataChange', function (event) {
        currentDataChange(event.detail)
      })
    })

    function init() {
      const kitBox = document.querySelector('#kitBox')
      kitBox.init([defaultImage, defaultText])
    }

    function add() {
      const kitBox = document.querySelector('#kitBox')
      kitBox.add({
        ...defaultImage,
        id: new Date().getTime(),
      })
    }

    function addText() {
      const kitBox = document.querySelector('#kitBox')
      kitBox.add({
        ...defaultText,
        id: new Date().getTime(),
      })
    }

    async function getList() {
      const kitBox = document.querySelector('#kitBox')
      const list = await kitBox.getDomList()
      console.log(list)
    }

    function currentDataChange(data) {
      if (!data.id) {
        return
      }
      currentData = data
      const form = document.querySelector('#form')
      form.innerHTML = ''
      Object.entries(data).forEach(([key, value]) => {
        const div = document.createElement('div')
        const input = document.createElement('input')
        input.type = 'text'
        input.name = key
        input.value = value
        if (key === 'type' || key === 'id' || key === 'image') {
          input.disabled = true
        }
        div.innerText = `${key}: `
        div.appendChild(input)
        form.appendChild(div)
      })
    }

    function updateCurrentData() {
      const form = document.querySelector('#form')
      const formData = new FormData(form)
      const params = {}
      formData.entries().forEach(([key, value]) => {
        if (key === 'image') {
          params[key] = currentData.image
        } else {
          params[key] = value
        }
      })
      const kitBox = document.querySelector('#kitBox')
      kitBox.updateCurrentData({
        ...currentData,
        ...params,
      })
    }

    function createPoster() {
      const kitBox = document.querySelector('#kitBox')
      kitBox.createPoster().then((canvas) => {
        console.log(canvas)
        const img = document.querySelector('.canvasPoster')
        img.src = canvas.toDataURL('image/png')
        img.onload = () => {
          URL.revokeObjectURL(img.src)
        }
      })
    }
  </script>
</html>
